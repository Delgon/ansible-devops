---
# Prepare rclone config file
# -----------------------------------------------------------------------------
# Get pod information
- name: "Get pod information"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    name: "{{ masbr_cp_pod_name }}"
    namespace: "{{ masbr_cp_namespace }}"
  register: _pod_info

- name: "Set fact: pod infomation"
  set_fact:
    masbr_cp_service_account_name: "{{ _pod_info.resources[0].spec.serviceAccountName }}"
    masbr_cp_service_account: "{{ _pod_info.resources[0].spec.serviceAccount }}"
    masbr_cp_security_context: "{{ _pod_info.resources[0].spec.securityContext }}"

- name: "Get path of config file in use"
  shell: >
    rclone config file | tail -1
  register: _config_file_path

# Copy config file to pod
- name: "Copy config file to pod"
  shell: >
    oc cp --retries=50 -c {{ masbr_cp_container_name }} {{ _config_file_path.stdout }} 
    {{ masbr_cp_namespace }}/{{ masbr_cp_pod_name }}:{{ masbr_cp_config_folder }}/rclone.conf


# Create NetworkPolicy and Job
# -----------------------------------------------------------------------------
- name: "Set fact: copy file job name"
  set_fact:
    # must be no more than 63 characters and in lower case
    masbr_cp_name: "{{ masbr_job_type }}-{{ masbr_job_component.name }}-{{ masbr_job_version | lower}}"

# Create NetworkPolicy
- name: "Create NetworkPolicy"
  kubernetes.core.k8s:
    template: "{{ role_path }}/../../common_tasks/templates/backup_restore/network_policy.yml.j2"
    state: present
    wait: true

# Create Job
- name: "Create Job"
  kubernetes.core.k8s:
    template: "{{ role_path }}/../../common_tasks/templates/backup_restore/copy_file_job.yml.j2"
    state: present
    wait: true

# Wait for job to be completed
- name: "Wait for job to be completed (10s delay)"
  ignore_errors: True
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: "{{ masbr_cp_name }}"
    namespace: "{{ masbr_cp_namespace }}"
  register: _job_info
  until:
    - _job_info.resources is defined
    - _job_info.resources | length > 0
    - _job_info.resources | json_query('[*].status.conditions[?type==`Complete`][].status') | select ('match','True') | list | length == 1
  retries: "{{ (masbr_copy_timeout_sec|int // 10) | int  }}"
  delay: 10
