---
# Copy files from local storage to pod
# -----------------------------------------------------------------------------
- name: "Copy files from local storage to pod"
  when: masbr_use_local_storage
  block:
    # Local storage job folder
    - name: "Set fact: local storage job folder"
      set_fact:
        masbr_storage_job_folder: >-
          {{ masbr_storage_local_folder }}/{{ masbr_cf_job_type }}s/{{ masbr_cf_job_name }}

    - name: "Debug: local storage job folder"
      debug:
        msg: "Local storage job folder .......... {{ masbr_storage_job_folder }}"

     # Copy files
    - name: "Copy files from local storage to pod"
      shell: >-
        oc exec {{ masbr_cf_pod_name }} -c {{ masbr_cf_container_name }} -n {{ masbr_cf_namespace }} -- bash -c
        'mkdir -p {{ item.dest_folder }}';
        oc cp --retries=50 -c {{ masbr_cf_container_name }}
        {{ [masbr_storage_job_folder, item.src_file] | path_join }}
        {{ masbr_cf_namespace }}/{{ masbr_cf_pod_name }}:{{ [item.dest_folder, item.src_file|basename] | path_join }}
      loop: "{{ masbr_cf_paths }}"


# Copy files from cloud storage to pod
# -----------------------------------------------------------------------------
- name: "Copy files from cloud storage to pod"
  when: masbr_use_cloud_storage
  block:
    # Cloud storage job folder
    - name: "Set fact: cloud storage job folder"
      set_fact:
        masbr_storage_job_folder: >-
          {{ masbr_storage_cloud_rclone_name }}:{{ masbr_storage_cloud_bucket }}/{{ masbr_cf_job_type }}s/{{ masbr_cf_job_name }}

    - name: "Debug: cloud storage job folder"
      debug:
        msg: "Cloud storage job folder .......... {{ masbr_storage_job_folder }}"

    # Copy files from cloud storage to mounted pvc folder
    - name: "Set fact: restore folder in pvc"
      set_fact:
        masbr_cf_pvc_job_folder: >-
          {{ [masbr_cf_pvc_mount_path, 'restore', masbr_cf_job_name] | path_join }}

    - name: "Debug: job folder in pvc"
      debug:
        msg: "Job folder in pvc ......... {{ masbr_cf_pvc_job_folder }}"

    - name: "Set fact: rclone mkdir command"
      set_fact:
        masbr_cf_cmds: "rclone version; mkdir -p {{ masbr_cf_pvc_job_folder }}"

    - name: "Set fact: rclone copy file command"
      set_fact:
        masbr_cf_cmds: >-
          {{ masbr_cf_cmds }};
          rclone --links --progress --no-check-certificate --config ${MASBR_STORAGE_CLOUD_RCLONE_FILE}
          --log-file {{ masbr_cf_pvc_job_folder }}/rclone.log --log-level DEBUG copy
          {{ [masbr_storage_job_folder, item.src_file] | path_join }}
          {{ [masbr_cf_pvc_job_folder, item.dest_folder|basename] | path_join }}
      loop: "{{ masbr_cf_paths }}"

    - name: "Debug: rclone copy file command"
      debug:
        msg: "Rclone copy file command .......... {{ masbr_cf_cmds }}"

    # Create copy file Job:
    # 1. The Job pod will mount the PVC where the files will be saved to
    # 2. Use rclone to copy files from COS to PVC
    - name: "Create copy file Job"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/create_copy_cloud_files_job.yml"

    # Copy files from mounted pvc folder to dest folder
    - name: "Copy files from mounted pvc folder to dest folder"
      shell: >-
        oc exec {{ masbr_cf_pod_name }} -c {{ masbr_cf_container_name }} -n {{ masbr_cf_namespace }} -- bash -c
        'mkdir -p {{ item.dest_folder }};
        cp -f {{ [masbr_cf_pvc_job_folder, item.dest_folder|basename, item.src_file|basename ] | path_join }}
        {{ item.dest_folder }};
        ls -lA {{ item.dest_folder }}'
      loop: "{{ masbr_cf_paths }}"
      register: _pvc_copy_output

    - name: "Debug: list files in dest folder"
      debug:
        msg: "{{ _pvc_copy_output.results[-1].stdout_lines }}"

  always:
    # Clean up
    - name: "Delete job folder in mounted pvc"
      shell: >-
        oc exec {{ masbr_cf_pod_name }} -c {{ masbr_cf_container_name }} -n {{ masbr_cf_namespace }} -- bash -c
        'rm -rf {{ masbr_cf_pvc_job_folder }}'

    - name: "Delete copy file Job"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/delete_copy_cloud_files_job.yml"


# Copy files from pod to pvc storage
# -----------------------------------------------------------------------------
