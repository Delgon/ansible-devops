---
# Check the existence of the backup job
# -----------------------------------------------------------------------------
- name: "Set fact: the Completed backup job name"
  set_fact:
    masbr_restore_from_completed: "{{ masbr_restore_from }}-Completed"

- name: "Check the existence of the backup job"
  include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/list_storage_job_folders.yml"
  vars:
    - masbr_ls_job_type: "backup"
    - masbr_ls_filter: "| grep {{ masbr_restore_from_completed }}"

- name: "Fail if not found a Completed backup job"
  assert:
    that: masbr_ls_results is defined and masbr_ls_results | length == 1
    fail_msg: >-
      Not found the backup job folder:
      {{ masbr_storage_job_type_folder }}/{{ masbr_restore_from_completed }}


# Get backup job information
# -----------------------------------------------------------------------------
- name: "Get backup job information"
  include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/copy_storage_files_to_local.yml"
  vars:
    masbr_cf_job_type: "backup"
    masbr_cf_job_name: "{{ masbr_restore_from_completed }}"
    masbr_cf_paths:
      - src_file: "backup.yml"
        dest_folder: "from"

- name: "Set fact: backup job information"
  set_fact:
    masbr_restore_from_yaml: "{{ lookup('file', masbr_local_job_folder + '/from/backup.yml') | from_yaml }}"

- name: "Set fact: if this is an incremental backup"
  set_fact:
    masbr_restore_from_incr: "{{ true if masbr_restore_from_yaml.type == 'incr' else false }}"

- name: "Debug: backup job information"
  debug:
    msg: "{{ masbr_restore_from_yaml }}"


# This is an incremental backup, also need to check the existance of the ancestor full backup
# -----------------------------------------------------------------------------
- name: "Check the existence of the ancestor full backup job"
  when: masbr_restore_from_incr
  block:
    - name: "Fail if not found 'from' specified in this incremental backup job information"
      assert:
        that: masbr_restore_from_yaml.from is defined and masbr_restore_from_yaml.from | length > 0
        fail_msg: "Not found 'from' specified in this incremental backup job information"

    - name: "Set fact: the ancestor full backup job name"
      set_fact:
        masbr_restore_ancestor: "{{ masbr_restore_from_yaml.from }}"
        masbr_restore_ancestor_completed: "{{ masbr_restore_from_yaml.from }}-Completed"

    - name: "Check the existence of the ancestor full backup job"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/list_storage_job_folders.yml"
      vars:
        - masbr_ls_job_type: "backup"
        - masbr_ls_filter: "| grep {{ masbr_restore_ancestor_completed }}"

    - name: "Fail if not found a Completed ancestor full backup job"
      assert:
        that: masbr_ls_results is defined and masbr_ls_results | length == 1
        fail_msg: >-
          Not found the ancestor full backup job folder:
          {{ masbr_storage_job_type_folder }}/{{ masbr_restore_ancestor_completed }}
