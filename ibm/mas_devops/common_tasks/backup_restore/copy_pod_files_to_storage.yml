---
# Copy backup files from pod to local storage
# -----------------------------------------------------------------------------
- name: "Copy backup files from pod to local storage"
  when: masbr_use_local_storage
  block:
    # Create target folder 
    - name: "Set fact: local storage dest folder"
      set_fact:
        masbr_storage_dest_folder: "{{ masbr_storage_local_folder }}/backups/{{ masbr_job_name }}/{{ masbr_cp_dest_folder }}"
      
    - name: "Debug: local storage dest folder"
      debug:
        msg: "Local storage dest folder ......... {{ masbr_storage_dest_folder }}"

    - name: "Create local storage dest folder"
      file:
        path: "{{ masbr_storage_dest_folder }}"
        state: directory

    # Copy files
    - name: "Copy backup files from pod to local storage"
      shell: >
        oc cp --retries=50 -c {{ masbr_cp_container_name }} {{ masbr_cp_namespace }}/{{ masbr_cp_pod_name }}:{{ item }} 
        {{ masbr_storage_dest_folder }}/{{ item | basename }} 
      register: _oc_cp_output
      loop: "{{ masbr_cp_src_files }}"


# Copy backup files from pod to cloud storage
# -----------------------------------------------------------------------------
- name: "Copy backup files from pod to cloud storage"
  when: masbr_use_cloud_storage
  block:
    # Define target folder
    - name: "Set fact: cloud storage dest folder"
      set_fact:
        masbr_storage_dest_folder: >-
          {{ masbr_storage_cloud_config }}:{{ masbr_storage_cloud_bucket }}/backups/{{ masbr_job_name }}/{{ masbr_cp_dest_folder }}
      
    - name: "Debug: cloud storage dest folder"
      debug:
        msg: "Cloud storage dest folder ......... {{ masbr_storage_dest_folder }}"
    
    # Define copy file command
    - name: "Set fact: copy file command"
      set_fact:
        masbr_cp_cmds: >-
          {{ masbr_cp_cmds | default('') }} 
          rclone --links --progress --no-check-certificate --config {{ masbr_cp_config_folder }}/rclone.conf 
          copy {{ item }} {{ masbr_storage_dest_folder }}; 
      loop: "{{ masbr_cp_src_files }}"

    - name: "Debug: copy file command"
      debug:
        msg: "Copy file command ................. {{ masbr_cp_cmds }}"

    # Create copy file job
    - name: "Create copy file job"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/create_copy_file_job.yml"

  always:
    # Delete copy file Job
    - name: "Delete copy file Job"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/delete_copy_file_job.yml"


# Copy backup files from pod to pvc storage
# -----------------------------------------------------------------------------
