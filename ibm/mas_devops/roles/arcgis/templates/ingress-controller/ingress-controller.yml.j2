apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ arcgis_ingress_controller_deployment_name }}"
  namespace: "{{ arcgis_namespace }}"
  labels:
    arcgis/app: ingress-nginx
    arcgis/siteName: "{{ arcgis_sitename }}"
    arcgis/instanceName: "{{ arcgis_selector_instance_name }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      arcgis/app: ingress-nginx
      arcgis/siteName: "{{ arcgis_sitename }}"
      arcgis/instanceName: "{{ arcgis_selector_instance_name }}"
  template:
    metadata:
      labels:
        arcgis/app: ingress-nginx
        arcgis/siteName: "{{ arcgis_sitename }}"
        arcgis/instanceName: "{{ arcgis_selector_instance_name }}"
        arcgis/restartTimestamp: "000"
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    arcgis/app: ingress-nginx
                    arcgis/siteName: "{{ arcgis_sitename }}"
                    arcgis/instanceName: "{{ arcgis_selector_instance_name }}"
                topologyKey: "{{ arcgis_k8s_availability_topology_key }}"
      # wait up to five minutes for the drain of connections
      terminationGracePeriodSeconds: 300
      serviceAccountName: "{{ arcgis_ingress_controller_service_account }}"
      # User running container also needs to run with arcgis group id
      securityContext:
        supplementalGroups: [{{ arcgis_supplemental_group_id }}]
      nodeSelector:
        kubernetes.io/os: linux
      containers:
        - name: main-container
          image: "{{ arcgis_ingress_controller_image_url }}"
          imagePullPolicy: "{{ arcgis_container_image_pull_policy }}"
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE
          resources:
            requests:
              cpu: "{{ arcgis_resource_cpu_min_ingress }}"
              memory: "{{ arcgis_resource_memory_min_ingress }}"
            limits:
              cpu: "{{ arcgis_resource_cpu_max_ingress }}"
              memory: "{{ arcgis_resource_memory_max_ingress }}"
          args:
            - /nginx-ingress-controller
            - --configmap=$(POD_NAMESPACE)/{{ arcgis_ingress_controller_nginx_config_map }}
            - --election-id={{ arcgis_ingress_controller_election_id }}
            - --tcp-services-configmap=$(POD_NAMESPACE)/{{ arcgis_ingress_controller_tcp_services_config_map }}
            - --udp-services-configmap=$(POD_NAMESPACE)/{{ arcgis_ingress_controller_udp_services_config_map }}
            - --publish-service=$(POD_NAMESPACE)/{{ arcgis_ingress_controller_service_name }}
            - --annotations-prefix=nginx.ingress.kubernetes.io
            - --watch-namespace=$(POD_NAMESPACE)
            - --ingress-class={{ arcgis_ingress_class }}
            - --update-status=false
            - --update-status-on-shutdown=false
            - --disable-sync-events
            - --default-ssl-certificate={{ arcgis_namespace }}/{{ arcgis_default_ingress_server_tls_secret_name }}
            # - --v=5 # for debug logs
            # https://kubernetes.github.io/ingress-nginx/user-guide/multiple-ingress/
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          ports:
            - name: https
              containerPort: 443
              protocol: TCP
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
          lifecycle:
            preStop:
              exec:
                command: [
                  "sh", "-c",
                  # Introduce a delay to the shutdown sequence to wait for the
                  # pod eviction event to propagate. Then, gracefully shutdown
                  # nginx.
                  "sleep 5 && nginx -s quit",
                ]
          volumeMounts:
          - mountPath: /etc/ingress-controller/auth
            name: auth
          - mountPath: /etc/ingress-controller/ssl
            name: ssl
      imagePullSecrets:
      - name: "{{ arcgis_container_image_pull_secret_name }}"
      volumes:
      - name: auth
        emptyDir: {}
      - name: ssl
        emptyDir: {}