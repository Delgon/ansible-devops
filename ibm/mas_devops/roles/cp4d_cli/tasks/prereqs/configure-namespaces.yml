---
# About this task:
# You must run the authorize-instance-topology command to apply the required permissions to the projects that are associated with an instance of IBM Cloud Pak for Data.
# The command:
# Creates the specified projects if they don't already exist.
# Creates the NamespaceScope operator in the operators project.
# Applies the require role to the operands project and any tethered projects.
# Binds the applied role to the service account of the NamespaceScope operator.

# More details: https://www.ibm.com/docs/en/cloud-paks/cp-data/4.8.x?topic=data-applying-required-permissions-projects-namespaces

# At this stage:
# - The two namespaces (ibm-cpd and ibm-cpd-operators) will be created
# - OperatorGroup will have been created in the ibm-cpd-operators namespace
# - Cloud Pak for Data Platform Operator (cpd-platform-operator-manager) v5.0 will be installed in ibm-cpd-operators namespace
# - IBM Cloud Pak Foundational Services (ibm-common-service-operator) v4 will be installed in ibm-cpd-operators namespace
# - IBM NamespaceScope Operator (ibm-namespace-scope-operator) v4 will be installed in ibm-cpd-operators namespace
# - A NamespaceScope will have been created in the ibm-cpd-operators namespace

#  Configure Cloud Pak for Data namespaces
# ---------------------------------------------------------------------------------------------------
# Set cpd-cli command to be executed
- name: "configure-namespaces : Set command : Configure Cloud Pak for Data namespaces"
  set_fact:
    cpd_cmd_auth_instance_topology: cpd-cli manage authorize-instance-topology \
      --cpd_operator_ns={{ cpd_operators_namespace }} \
      --cpd_instance_ns={{ cpd_instance_namespace }} 2>&1 | tee {{ role_path }}/logs/cpd_platform_config_namespaces_output.log

# Debug cpd-cli command to be executed
# The output can be copied/pasted in terminal in order to re-run cpd-cli command directly for troubleshooting purposes
- name: "configure-namespaces : Debug command : Configure Cloud Pak for Data namespaces"
  debug:
    msg:
      - "{{ cpd_cmd_auth_instance_topology | regex_replace(' \\\\', '') }}"

# Execute async cpd-cli command to configure namespaces
- name: "configure-namespaces : Running command : Configure Cloud Pak for Data namespaces (+- 15 minutes)"
  async: 900 # 15 minutes
  poll: 0
  shell: "{{ cpd_cmd_auth_instance_topology }}"
  register: cpd_config_namespaces_output

# Wait async cpd-cli cpd-cli command to configure namespaces
- name: "configure-namespaces : Waiting command execution : Configure Cloud Pak for Data namespaces..."
  async_status:
    jid: "{{ cpd_config_namespaces_output.ansible_job_id }}"
  register: cpd_config_namespaces_async_output
  until: cpd_config_namespaces_async_output.finished
  retries: 15 # wait up to 15 minutes
  delay: 60
  failed_when: cpd_config_namespaces_async_output.rc > 0 or ('authorize-instance-topology command ran successfully' not in cpd_config_namespaces_async_output.stdout)

# Debug cpd-cli command output
- name: "configure-namespaces : Debug command output: Configure Cloud Pak for Data namespaces"
  debug:
    msg: "{{ cpd_config_namespaces_async_output.stdout }}"
