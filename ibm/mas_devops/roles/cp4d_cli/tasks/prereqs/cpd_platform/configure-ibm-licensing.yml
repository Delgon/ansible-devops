---
# About this task:
# Before you install IBM Cloud Pak for Data, you must install the
# IBM Cloud Pak foundational services, Certificate manager and License Service.
# This task will install only IBM Cloud Pak Foundational Services and License Service
# and will verify if Certificate Manager have been installed.
# Certificate Manager should have been installed at this point using 'cert_manager' role.

# More details: https://www.ibm.com/docs/en/cloud-paks/cp-data/4.8.x?topic=cluster-installing-shared-components

# Check if and where IBM Licensing is installed
# ---------------------------------------------------------------------------------------------------
- name: "install-dependencies : Lookup for IBM Licensing deployment"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ibm-licensing-operator
    namespace: "{{ cpd_cs_control_namespace }}"
  register: licensing_deployment_lookup

# If IBM Licensing is already installed, then skip it as we don't need to install it again
- block:
    - debug:
        msg:
          - "IBM Licensing Services in already installed in {{ cpd_cs_control_namespace }} namespace, skipping..."

    - name: Pause for 15 seconds
      pause:
        seconds: 15
  when:
    - licensing_deployment_lookup.resources is defined
    - licensing_deployment_lookup.resources | length > 0

# If IBM Licensing is not installed yet, then run the task to get it installed
- when:
    - licensing_deployment_lookup.resources is not defined or licensing_deployment_lookup.resources | length == 0
  block:
    - debug:
        msg:
          - "Will install IBM Licensing Services in {{ cpd_cs_control_namespace }} namespace as it does not exist yet..."

    - name: Pause for 15 seconds
      pause:
        seconds: 15

    # Set cpd-cli command to be executed
    - name: "install-dependencies : Set command : Install Cloud Pak for Data dependency : IBM Licensing"
      set_fact:
        cpd_cmd_apply_cluster_components:
          cpd-cli manage apply-cluster-components \
          --release={{ cpd_product_version }} \
          --license_acceptance=true \
          --skip_components=ibm-cert-manager \
          --migrate_from_cs_ns={{ cpd_cpfs_namespace }} \
          --cert_manager_ns={{ cert_manager_namespace }} \
          --licensing_ns={{ cpd_cs_control_namespace }} 2>&1 | tee {{ cpd_logs_dir }}/cpd_platform_install_ibm_licensing_output.log

    # Debug cpd-cli command to be executed
    # The output can be copied/pasted in terminal in order to re-run cpd-cli command directly for troubleshooting purposes
    - name: "install-dependencies : Debug command : Install Cloud Pak for Data dependency : IBM Licensing"
      debug:
        msg:
          - "{{ cpd_cmd_apply_cluster_components | regex_replace(' \\\\', '') }}"

    # Execute cpd-cli command to install IBM licensing
    - name: "install-dependencies : Running command : Install Cloud Pak for Data dependency : IBM Licensing (up to 30 minutes)"
      async: 1800 # 15 minutes
      poll: 0
      shell: "{{ cpd_cmd_apply_cluster_components }}"
      register: cpd_install_ibm_licensing_output

    # Wait async cpd-cli cpd-cli command to install IBM licensing
    - name: "install-dependencies : Waiting command execution : Install Cloud Pak for Data dependency : IBM Licensing... (60s delay)"
      async_status:
        jid: "{{ cpd_install_ibm_licensing_output.ansible_job_id }}"
      register: cpd_install_ibm_licensing_async_output
      until: cpd_install_ibm_licensing_async_output.finished
      retries: 30 # wait up to 30 minutes
      delay: 60
      failed_when: ('apply-cluster-components command ran successfully' not in cpd_install_ibm_licensing_async_output.stdout)

    # Debug cpd-cli command output
    - name: "install-cr : Debug command output : Install Cloud Pak for Data dependency : IBM Licensing"
      debug:
        msg: "{{ cpd_install_ibm_licensing_async_output.stdout }}"
