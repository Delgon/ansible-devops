---
# This task runs 'cpd-cli manage apply-olm' command which is responsible for installing CPD related catalog sources and subscriptions

# Debug components to be installed
- name: "cpd-cli : Debug Cloud Pak for Data components to be installed"
  debug:
    msg:
      - "Release ......................... {{ cpd_product_version }}"
      - "Components ...................... {{ cpd_components_list }}"

# Set cpd-cli command to be executed
- name: "cpd-cli : Set command : Install Cloud Pak for Data operators : {{ cpd_components_list }}"
  set_fact:
    cpd_cmd_apply_olm: cpd-cli manage apply-olm \
      --release={{ cpd_product_version }} \
      --cpd_operator_ns={{ cpd_operators_namespace }} \
      --components={{ cpd_components }} 2>&1 | tee {{ role_path }}/logs/cpd_components_install_operators.log

# Debug cpd-cli command to be executed
# The output can be copied/pasted in terminal in order to re-run cpd-cli command directly for troubleshooting purposes
- name: "cpd-cli : Debug command : Install Cloud Pak for Data operators : {{ cpd_components_list }}"
  debug:
    msg:
      - "{{ cpd_cmd_apply_olm | regex_replace(' \\\\', '') }}"

# Execute async cpd-cli command to install corresponding operators
- name: "cpd-cli : Running command : Install Cloud Pak for Data operators : {{ cpd_components_list }} (up to 60 minutes)"
  async: 3600 # 60 minutes
  poll: 0
  shell: "{{ cpd_cmd_apply_olm }}"
  register: cpd_install_operator_output

# Wait async cpd-cli command to install corresponding operators
- name: "cpd-cli : Waiting command execution : Install Cloud Pak for Data operators : {{ cpd_components_list }}... (60s delay)"
  async_status:
    jid: "{{ cpd_install_operator_output.ansible_job_id }}"
  register: cpd_install_operator_async_output
  until: cpd_install_operator_async_output.finished
  retries: 60 # wait up to 60 minutes
  delay: 60
  failed_when: ('apply-olm command ran successfully' not in cpd_install_operator_async_output.stdout)

# Debug cpd-cli command output
- name: "cpd-cli : Debug command output: Install Cloud Pak for Data operators : {{ cpd_components_list }}"
  debug:
    msg: "{{ cpd_install_operator_async_output.stdout }}"
