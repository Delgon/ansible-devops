
---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "{{ arcgis_ingress_controller_service_account }}"
  namespace: "{{ mas_arcgis_namespace }}"
  labels:
    arcgis/app: ingress-nginx
    arcgis/siteName: "{{ arcgis_sitename }}"
---
# Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: "{{ arcgis_ingress_controller_role }}"
  namespace: "{{ mas_arcgis_namespace }}"
  labels:
    arcgis/app: ingress-nginx
    arcgis/siteName: "{{ arcgis_sitename }}"
rules:
  - apiGroups:
      - ""
    resources:
      - namespaces
    verbs:
      - get
  - apiGroups:
      - ""
    resources:
      - configmaps
      - pods
      - secrets
      - services
      - endpoints
    verbs:
      - list
      - watch
      - get
  - apiGroups:
      - "discovery.k8s.io"
    resources:
      - endpointslices
    verbs:
      - get
      - list
      - watch
  # Note: When below is enabled, ingress-controller is logging
  # Lot and Lots of event messages without any useful information.
  # So, disabling this functionality for now.
  #  - apiGroups:
  #    - ""
  #    resources:
  #      - events
  #    verbs:
  #      - create
  #      - patch
  - apiGroups:
      - "networking.k8s.io"
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
#  - apiGroups:
#    - "networking.k8s.io"
#    resources:
#      - ingresses/status
#    verbs:
#      - update
  - apiGroups:
      - "coordination.k8s.io"
    resources:
      - leases
    resourceNames:
      # To update this set the --election-id parameter properly
      - "{{ arcgis_ingress_controller_election_id }}"
      - "{{ arcgis_ingress_controller_private_election_id }}"
    verbs:
      - get
      - update
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: "{{ arcgis_ingress_controller_role_binding }}"
  namespace: "{{ mas_arcgis_namespace }}"
  labels:
    arcgis/app: ingress-nginx
    arcgis/siteName: "{{ arcgis_sitename }}"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: "{{ arcgis_ingress_controller_role }}"
subjects:
  - kind: ServiceAccount
    name: "{{ arcgis_ingress_controller_service_account }}"
    namespace: "{{ mas_arcgis_namespace }}"
