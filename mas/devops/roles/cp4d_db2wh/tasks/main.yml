---
# 1. Provide debug information to the user
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "Namespace ........... {{ cpd_meta_namespace }}"
      - "Storage class ....... {{ cpd_storage_class }}"
      - "Db2 database name ... {{ db2wh_dbname }}"
      - "Db2 version ......... {{ db2wh_version }}"


# 2. Install CP4D services for db2
# -----------------------------------------------------------------------------
- name: "Install Db2 warehouse CPDService"
  community.kubernetes.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/cpdservice.yml') }}"

- name: "Wait for Db2 warehouse CPDService to be ready (60s delay)"
  community.kubernetes.k8s_info:
    api_version: metaoperator.cpd.ibm.com/v1
    kind: CPDService
    name: cpdservice-db2wh
    namespace: "{{ cpd_meta_namespace }}"
  register: _cpd_service
  until:
    - _cpd_service.resources | length > 0
    - _cpd_service.resources[0].status is defined
    - _cpd_service.resources[0].status.code == '0'
    - _cpd_service.resources[0].status.status == 'Ready'
    - _cpd_service.resources[0].status.message == 'Completed'
  retries: 60 # approx 1 hour before we give up
  delay: 60 # 1 minute


# 3. Create a Db2 instance
# -----------------------------------------------------------------------------
- name: "Create db2wh Instance"
  community.kubernetes.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/db2ucluster.yaml') }}"
  register: _db2_cluster_result

- name: "Install Db2 warehouse Console"
  community.kubernetes.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/dmc.yml') }}"

- name: "Wait for Db2 Management Console CPDService to be ready (60s delay)"
  community.kubernetes.k8s_info:
    api_version: metaoperator.cpd.ibm.com/v1
    kind: CPDService
    name: cpdservice-db2wh-dmc
    namespace: "{{ cpd_meta_namespace }}"
  register: _cpd_service_dmc
  until:
    - _cpd_service_dmc.resources | length > 0
    - _cpd_service_dmc.resources[0].status is defined
    - _cpd_service_dmc.resources[0].status.code == '0'
    - _cpd_service_dmc.resources[0].status.status == 'Ready'
    - _cpd_service_dmc.resources[0].status.message == 'Completed'
  retries: 60 # approx 1 hour before we give up
  delay: 60 # 1 minute

- include_tasks: tasks/suite_jdbccfg.yml
  when:
    - mas_instance_id is defined
    - db2wh_cfg_file is defined
